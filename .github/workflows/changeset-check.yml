# Validates that PRs with package changes include a changeset
name: Changeset Check

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  check:
    name: Changeset Status
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check for changeset
        run: |
          # Fetch base branch for comparison
          git fetch origin ${{ github.base_ref }} --depth=1

          # Check if there are changes to packages that would need a changeset
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check if any package source files changed (excluding tests, configs)
          if echo "$CHANGED_FILES" | grep -qE '^packages/(cli|engine|renderer|github|types)/src/'; then
            echo "üì¶ Package source files changed, checking for changeset..."

            # Check if a changeset was added
            if echo "$CHANGED_FILES" | grep -qE '^\.changeset/.*\.md$'; then
              echo "‚úÖ Changeset found!"
            else
              echo "‚ö†Ô∏è No changeset found. If this PR includes user-facing changes, please run:"
              echo ""
              echo "  bun changeset"
              echo ""
              echo "If this is an internal change (tests, refactoring), you can ignore this warning."
              # Don't fail - just warn
            fi
          else
            echo "‚ÑπÔ∏è No package source changes detected, changeset not required"
          fi
